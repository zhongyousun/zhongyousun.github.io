---
title: "C# å¤šåŸ·è¡Œç·’åŸç†ã€éåŒæ­¥ç”¨æ³•èˆ‡å¸¶å…¥è‡ªå®šç¾©ç‰©ä»¶"
slug: "tutorials/Csharp-multithreading"
date: 2023-01-19T11:49:15+08:00
draft: false
thumbnail: "" # Thumbnail image
description: "C# å¤šåŸ·è¡Œç·’åŸç†ã€éåŒæ­¥ç”¨æ³•èˆ‡å¸¶å…¥è‡ªå®šç¾©ç‰©ä»¶ç´€éŒ„"
categories:
  - "ç¨‹å¼èªè¨€"
tags:
  - "Csharp"
# Theme-Defined params
lead: "" # Lead text
toc: ture
sidebar: right
---
C# å¤šåŸ·è¡Œç·’åŸç†ã€éåŒæ­¥ç”¨æ³•èˆ‡å¸¶å…¥è‡ªå®šç¾©ç‰©ä»¶å­¸ç¿’éç¨‹ç´€éŒ„ã€‚  
ç›®å‰é‡åˆ°çš„å°ˆæ¡ˆéƒ½æ²’æœ‰ç¡¬æ€§éœ€æ±‚ä½¿ç”¨åˆ°å¤šåŸ·è¡Œç·’ï¼Œæ­¤ç¯‡ç‚ºç´€éŒ„è‡ªå·±çš„ç†è§£èˆ‡å­¸ç¿’çš„éç¨‹ã€‚
<!--more-->

### å‰è¨€
å…¬å¸å°ˆæ¡ˆæœ‰å€‹æª”æ¡ˆé å…ˆå„²å­˜çš„åŠŸèƒ½ï¼Œå› ç‚ºæ¯å¤©éƒ½æœ‰æ–°æª”æ¡ˆï¼Œéœ€è¦æ¯å¤©è·‘æ’ç¨‹åŸ·è¡Œã€‚åŸæœ¬çš„å¯«æ³•ï¼Œæ˜¯Açš„éƒ¨åˆ†ä¸‹è¼‰å®Œï¼Œå†ä¸‹è¼‰Bçš„éƒ¨åˆ†ã€‚æœƒæƒ³è©¦è©¦çœ‹æ”¹ç”¨å¤šåŸ·è¡Œç·’çš„æ–¹å¼å¯«çš„åŸå› ï¼Œä¸»è¦åªæ˜¯è¦ºå¾—åœ¨æ¸¬è©¦æ™‚è³‡æ–™é‡å¤ªå¤§ï¼Œéœ€è¦å…ˆç­‰Aè·‘å®Œæ‰èƒ½æ¸¬è©¦Bçš„éƒ¨åˆ†å¾ˆç…©è€Œå·²ã€‚ğŸ˜  

### åŸç†
å¾—å…ˆäº†è§£Program(ç¨‹å¼)/Process(ç¨‹åº)/Thread(åŸ·è¡Œç·’)çš„å·®ç•°ã€‚

1. **Program(ç¨‹å¼)** : é‚„å°šæœªè¼‰å…¥è¨˜æ†¶é«”çš„ç¨‹å¼ä»£ç¢¼ã€‚ 
2. **Process(ç¨‹åº)** : å·²ç¶“åŸ·è¡Œä¸¦ä¸”è¼‰å…¥åˆ°è¨˜æ†¶é«”ä¸­çš„ Program ï¼Œç¨‹åºä¸­çš„æ¯ä¸€è¡Œç¨‹å¼ç¢¼éš¨æ™‚éƒ½æœ‰å¯èƒ½è¢«CPUåŸ·è¡Œã€‚  
3. **Thread(åŸ·è¡Œç·’)** : åŒä¸€å€‹ Process ä¸­æœƒæœ‰å¾ˆå¤šå€‹ Thread ï¼Œæ¯ä¸€å€‹ Thread è² è²¬æŸä¸€é …åŠŸèƒ½ã€‚  

ä»¥å·¥å» ä¾†èˆ‰ä¾‹:  

**Program(ç¨‹å¼)** = å·¥å» çš„è©³ç´°è£½é€ åœ–èˆ‡äººå“¡é…ç½®  
**Process(ç¨‹åº)** = å·²ç¶“åœ¨é‹è¡Œçš„å·¥å»   
**Thread(åŸ·è¡Œç·’)** = å·¥å» è£¡çš„æ¯ä½å·¥ä½œäººå“¡  

æ™®éç¨‹å¼åŸ·è¡Œæ™‚éƒ½æ˜¯ç…§è‘—é †åºä¸€è¡Œä¸€è¡ŒåŸ·è¡Œï¼Œç›¸ä¼¼æ–¼å·¥å» è£¡çš„å·¥äººç…§è‘—é †åºå®Œæˆè‡ªå·±çš„ä»»å‹™ã€‚é€™å°±æœƒç”¢ç”Ÿç¨‹å¼åŸ·è¡Œéä¹…ï¼Œå·¥äººé‹ç”¨æ•ˆç‡ä¸é«˜çš„å•é¡Œï¼Œå¦‚æœå·¥äººå€‘å¯ä»¥åŒæ™‚åŸ·è¡Œå„è‡ªçš„ä»»å‹™(å¤šåŸ·è¡Œç·’)ï¼Œé€™æ¨£æ•ˆç‡å°±æœƒè®Šå¿«å¾ˆå¤šï¼Œä½†ç¼ºé»å°±æ˜¯ç¡¬é«”ä¸è¶³æ™‚(å·¥å» ç©ºé–“å¤ªå°)ï¼Œå¤ªå¤šå·¥äººä¸€èµ·åŸ·è¡Œä»»å‹™å°±æœƒäº’æ¶è³‡æºå°è‡´ç¨‹å¼**æ­»çµ(Deadlock)**ã€‚

### ç”¨é€”
ä½¿ç”¨å¤šåŸ·è¡Œç·’çš„æƒ…æ³é€šå¸¸åŒ…æ‹¬ï¼š

1. éœ€è¦åŒæ™‚åŸ·è¡Œå¤šå€‹ä»»å‹™ï¼Œè€Œé€™äº›ä»»å‹™ä¹‹é–“æ²’æœ‰é—œè¯ã€‚ä¾‹å¦‚ï¼ŒåŒæ™‚ä¸‹è¼‰å¤šå€‹æ–‡ä»¶æˆ–è¨ˆç®—å¤šå€‹å€¼ã€‚
2. éœ€è¦ç­‰å¾…ä¸€å€‹é•·æ™‚é–“é‹è¡Œçš„ä»»å‹™ï¼Œä½†ä¸æƒ³è®“ç•Œé¢è®Šå¾—ä¸å¯äº’å‹•ã€‚ä¾‹å¦‚ï¼Œåœ¨åŒæ™‚é‹è¡Œçš„å¦ä¸€å€‹åŸ·è¡Œç·šä¸­åŸ·è¡Œè³‡æ–™åº«æŸ¥è©¢ã€‚
3. éœ€è¦åŸ·è¡Œä¸€å€‹ä»»å‹™ï¼Œä½†ä¸æƒ³å› ç‚ºå®ƒé˜»å¡å…¶ä»–ä»»å‹™ã€‚ä¾‹å¦‚ï¼Œåœ¨åŒæ™‚é‹è¡Œçš„å¦ä¸€å€‹åŸ·è¡Œç·šä¸­åŸ·è¡Œç¶²è·¯é€£æ¥ã€‚
4. éœ€è¦åœ¨å¤šå€‹æ ¸å¿ƒä¸ŠåŸ·è¡Œä»»å‹™ï¼Œä»¥åˆ©ç”¨å¤šæ ¸ CPU çš„æ€§èƒ½ã€‚

### ç¯„ä¾‹
```C# {linenos=inline}
using System.Threading;

Thread thread1 = new Thread(Task1); 
thread1.Start();

Thread thread2 = new Thread(Task2);
thread2.Start();

Console.WriteLine("Completed");
Console.ReadKey();

static void Task1()
{
    for (int i = 0; i < 5; i++)
    {
        Console.WriteLine("Task 1");
        Thread.Sleep(1000);
    }
}

static void Task2()
{
    for (int i = 0; i < 5; i++)
    {
        Console.WriteLine("Task 2");
        Thread.Sleep(1000);
    }
}

```
çµæœ:
```
Completed
Task 1
Task 2
Task 1
Task 2
Task 1
Task 2
Task 1
Task 2
Task 2
Task 1

```
**ç‚ºä»€éº¼æœƒå…ˆå‡ºç¾ "Completed" ?**  
é€™æ˜¯å› ç‚ºåœ¨ä¸Šé¢çš„ç¨‹å¼ç¢¼ä¸­ï¼Œå…©å€‹åŸ·è¡Œç·’è¢«åŒæ™‚å•Ÿå‹•ï¼Œä¸¦ä¸”ä¸»åŸ·è¡Œç·’ä¸ç­‰å¾…å…¶ä¸­ä»»ä½•ä¸€å€‹åŸ·è¡Œç·’å®Œæˆï¼Œè€Œæ˜¯ç«‹å³å¯«å‡º "Completed" ä¸¦çµæŸç¨‹å¼ã€‚å› æ­¤ï¼Œç„¡è«–å“ªå€‹åŸ·è¡Œç·’å…ˆå®Œæˆï¼Œç¨‹å¼éƒ½æœƒå…ˆå¯«å‡º "Completed"ã€‚

å¦‚æœæƒ³è¦ç­‰å¾… thread2 å®Œæˆï¼Œå¯ä»¥åŠ ä¸Š thread2.Join() ä½¿ä¸»åŸ·è¡Œç·’ç­‰å¾… thread2 åŸ·è¡Œå®Œç•¢ï¼Œå†æ¥è‘—åŸ·è¡Œ```Console.WriteLine("Completed");```ã€‚

### å¸¶å…¥è‡ªå®šç¾©åƒæ•¸
å¯¦éš›ä½¿ç”¨æ™‚åŸ·è¡Œç·’å¸¸æœƒæœ‰å¸¶å…¥åƒæ•¸çš„éœ€æ±‚ï¼Œå¯ä»¥ä½¿ç”¨ParameterizedThreadStartï¼ŒParameterizedThreadStartæ˜¯ä¸€å€‹å§”æ´¾ï¼Œå®ƒæŒ‡å‘ä¸€å€‹objectåƒæ•¸ä¸¦æ²’æœ‰è¿”å›å€¼çš„æ–¹æ³•ã€‚æ‰€ä»¥åœ¨ä½¿ç”¨ParameterizedThreadStart å§”æ´¾æ™‚ï¼Œéœ€è¦å‚³å…¥ä¸€å€‹objecté¡å‹åƒæ•¸ã€‚  
ä½†é€šå¸¸è³‡æ–™é¡å‹éƒ½ä¸æœƒæ˜¯objectï¼Œå¤§éƒ¨åˆ†æ˜¯JObjectæˆ–æ˜¯è‡ªå®šç¾©çš„é¡å‹ï¼Œä»¥ä¸‹æ˜¯å¯¦ä½œæ–¹å¼ã€‚  

é‡å°ä¸åŒåŸ·è¡Œç·’å»ºç«‹å°æ‡‰çš„ç‰©ä»¶
```C# {linenos=inline}
// Create an object to hold the list
class ListContainer1
    {
        public List<dynamic> TheList { get; set; }
    }
class ListContainer2
    {
        public List<customize> TheList { get; set; }
    }


```
å‚³é ```List<dynamic>``` customize_obj è‡³ Task1ï¼Œåœ¨ Task1 å‡½å¼ä¸­å–å¾— customize_obj ä¸¦åŸ·è¡Œ
```C# {linenos=inline}
List<dynamic> customize_obj  = new List<dynamic>();
var listContainer1 = new ListContainer1 { TheList = customize_obj };
// create new thread
Thread t1 = new Thread(new ParameterizedThreadStart(Task1));
// pass parameters and start thread
t1.Start(listContainer1);


void Task1(Object listContainer)
{
    // get customize_obj
    ListContainer1 container = (ListContainer1)listContainer;
    List<dynamic> customize_obj = container.TheList;
    //...
    //code
    //...
}

```  
  


### éåŒæ­¥æ–¹æ³•(å¾…çºŒ)